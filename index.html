<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Trainer</title>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

</head>
<body class="">

<div class="main-container" id="main-container">
    <div class="board-area" id="board-area">
        <div class="board-wrapper" id="board-wrapper">
            <div id="eval-bar-container" class="hidden">
                <div id="eval-score">0.0</div>
                <div id="eval-fill"></div>
            </div>
            <svg id="arrow-overlay"></svg>
            <div id="board" class="board-theme-green"></div>
        </div>

        <div id="training-note-display" class="training-note">
            <div class="note-content">
                <i class="fas fa-info-circle"></i>
                <span id="note-text"></span>
            </div>
            <button class="continue-btn" onclick="continueFromNote()">Weiter</button>
        </div>
    </div>

    <div class="resizer" id="resizer"></div>

    <div class="controls-area" id="controls-area">
        <div class="header-row">
            <h2><i class="fas fa-chess-knight"></i> Trainer</h2>
            <button class="settings-btn" onclick="openSettings()" title="Einstellungen"><i class="fas fa-gear"></i></button>
        </div>

        <div id="view-mode">
            <div class="color-switch">
                <button class="color-btn active" onclick="setSide('white')">Weiß</button>
                <button class="color-btn" onclick="setSide('black')">Schwarz</button>
            </div>
            <div id="search-active-banner" class="search-banner hidden">
                <span><i class="fas fa-filter search-filter-icon"></i> Filter aktiv</span>
                <button onclick="resetBoardSearch()">Reset</button>
            </div>
            <div id="lines-list" class="scrollable-list"></div>
            <div class="action-group">
                <button class="action-btn" onclick="startAddingLine()"><i class="fas fa-plus"></i> Neu</button>
                <button class="action-btn secondary" onclick="openSelectionMode()"><i class="fas fa-play"></i> Üben</button>
            </div>
        </div>

        <div id="bot-setup-mode" class="hidden">
             <div class="bot-setup-header">
                <h2 class="bot-setup-title">Gegen Bot spielen</h2>
            </div>
            <div class="settings-container">
                <div class="training-card bot-setup-card">
                    <div class="category-label">Bot Stärke (ELO)</div>
                    <div class="active-category-title" id="elo-display">1500</div>
                    <input type="range" id="elo-slider" min="500" max="3300" step="50" value="1500" oninput="updateEloDisplay(this.value)">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-muted);">
                        <span>Anfänger (500)</span>
                        <span>Großmeister (3300)</span>
                    </div>
                </div>
                
                <div class="training-card">
                    <div class="category-label">Ausgewählte Variante</div>
                    <div id="bot-line-preview" class="bot-line-preview"></div>
                </div>
            </div>
             <div class="action-group">
                <button class="action-btn" onclick="launchBotGame()"><i class="fas fa-robot"></i> Spiel starten</button>
                <button class="action-btn secondary" onclick="switchUI('view-mode')">Abbrechen</button>
            </div>
        </div>

        <div id="bot-play-mode" class="hidden">
            <div class="training-dashboard">
                <div class="training-card">
                    <div class="category-label">Gegner</div>
                    <div class="active-category-title">Stockfish <span style="font-size:1rem; color:var(--text-muted);" id="bot-play-elo"></span></div>
                    <div class="status-badge neutral" id="bot-status">Viel Erfolg!</div>
                </div>
            </div>
            <div class="action-group">
                <button class="action-btn secondary danger-text" onclick="stopBotGame()">Spiel beenden</button>
            </div>
        </div>

        <div id="settings-mode" class="hidden">
            <div class="settings-mode-header">
                <h2>Einstellungen</h2>
                <button class="settings-btn" onclick="closeSettings()"><i class="fas fa-times"></i></button>
            </div>
            <div class="settings-container">
                <div class="settings-section">
                    <span class="settings-label">Datenverwaltung (Speichern & Laden)</span>
                    <div class="data-management-box">
                        <p>
                            Deine Daten werden automatisch in diesem Browser gespeichert. 
                            Um sie auf ein anderes Gerät zu übertragen, nutze diese Buttons:
                        </p>
                        <div class="data-management-actions">
                            <button class="action-btn secondary" onclick="exportData()"><i class="fas fa-download"></i> Backup speichern</button>
                            <button class="action-btn secondary" onclick="document.getElementById('import-file').click()"><i class="fas fa-upload"></i> Backup laden</button>
                            <input type="file" id="import-file" onchange="importData(this)">
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <span class="settings-label">Darstellung</span>
                    <div class="toggle-row" onclick="toggleThemeSetting()" id="setting-theme-row"><span>Dark Mode</span><div class="toggle-switch"></div></div>
                </div>
                    <div class="settings-section">
                        <span class="settings-label">Darstellung</span>
                    <div class="toggle-row" onclick="toggleThemeSetting()" id="setting-theme-row">
                        <span>Dark Mode</span><div class="toggle-switch"></div>
                    </div>
                    <div class="toggle-row" onclick="toggleSetting('treeView')" id="setting-treeview-row">
                        <span>Baum-Notation (Tree View)</span><div class="toggle-switch"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <span class="settings-label">Gameplay</span>
                    <div class="toggle-row" onclick="toggleSetting('sound')" id="setting-sound-row"><span>Soundeffekte</span><div class="toggle-switch"></div></div>
                    <div class="toggle-row" onclick="toggleSetting('coords')" id="setting-coords-row"><span>Koordinaten</span><div class="toggle-switch"></div></div>
                    <div class="toggle-row" onclick="toggleSetting('highlight')" id="setting-highlight-row"><span>Zug hervorheben</span><div class="toggle-switch"></div></div>
                    <div class="toggle-row" onclick="toggleSetting('autoRepeat')" id="setting-autorepeat-row"><span>Auto-Wiederholung bei Fehler</span><div class="toggle-switch"></div></div>
                    <div class="toggle-row" onclick="toggleEngine()" id="setting-engine-row"><span>Stockfish Analyse</span><div class="toggle-switch"></div></div>
                    <div class="toggle-row" onclick="toggleSortMode()" id="setting-sortmode-row"><span>Sortierung nach Können</span><div class="toggle-switch"></div></div>
                </div>
                <div class="settings-section">
                    <span class="settings-label">Animationen</span>
                    <div class="options-grid">
                        <div class="option-card" onclick="setAnimSpeed(300)" id="opt-anim-300">Slow</div>
                        <div class="option-card" onclick="setAnimSpeed(200)" id="opt-anim-200">Normal</div>
                        <div class="option-card" onclick="setAnimSpeed(0)" id="opt-anim-0">Aus</div>
                    </div>
                </div>
                <div class="settings-section">
                    <span class="settings-label">Brett Design</span>
                    <div class="options-grid">
                        <div class="option-card" onclick="setBoardColor('green')" id="opt-board-green"><span class="color-dot color-dot-green"></span></div>
                        <div class="option-card" onclick="setBoardColor('brown')" id="opt-board-brown"><span class="color-dot color-dot-brown"></span></div>
                        <div class="option-card" onclick="setBoardColor('blue')" id="opt-board-blue"><span class="color-dot color-dot-blue"></span></div>
                        <div class="option-card" onclick="setBoardColor('gray')" id="opt-board-gray"><span class="color-dot color-dot-gray"></span></div>
                        <div class="option-card" onclick="setBoardColor('purple')" id="opt-board-purple"><span class="color-dot color-dot-purple"></span></div>
                        <div class="option-card" onclick="setBoardColor('teal')" id="opt-board-teal"><span class="color-dot color-dot-teal"></span></div>
                    </div>
                </div>
                <div class="settings-section">
                    <span class="settings-label">Figuren</span>
                    <div class="options-grid">
                        <div class="option-card" onclick="setPieceTheme('wikipedia')" id="opt-piece-wikipedia">Standard</div>
                        <div class="option-card" onclick="setPieceTheme('alpha')" id="opt-piece-alpha">Alpha</div>
                        <div class="option-card" onclick="setPieceTheme('uscf')" id="opt-piece-uscf">USCF</div>
                        <div class="option-card" onclick="setPieceTheme('merida')" id="opt-piece-merida">Merida</div>
                        <div class="option-card" onclick="setPieceTheme('maestro')" id="opt-piece-maestro">Maestro</div>
                        <div class="option-card" onclick="setPieceTheme('leipzig')" id="opt-piece-leipzig">Leipzig</div>
                        <div class="option-card" onclick="setPieceTheme('tatiana')" id="opt-piece-tatiana">Tatiana</div>
                        <div class="option-card" onclick="setPieceTheme('cardinal')" id="opt-piece-cardinal">Cardinal</div>
                        <div class="option-card" onclick="setPieceTheme('blindfold')" id="opt-piece-blindfold">Blindfold</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="add-mode" class="hidden">
            <div class="add-mode-header">
                <h2>Neue Variante</h2>
                <button class="analyze-btn" onclick="toggleAnalysisMenu()">
                    <i class="fas fa-microscope"></i> Analysieren
                </button>
            </div>
            <input type="text" id="category-input" list="category-datalist" placeholder="Kategorie (z.B. Sizilianisch)...">
            <datalist id="category-datalist"></datalist>
            
            <textarea id="move-note-input" class="note-input" placeholder="Notiz zu dieser Stellung..."></textarea>
            
            <!-- Stockfish Analysis Section -->
            <div class="analysis-section hidden" id="analysis-section">
                <div class="explorer-header">
                    <i class="fas fa-robot"></i>
                    <span>Stockfish Analyse</span>
                    <span class="analysis-depth" id="analysis-depth"></span>
                </div>
                <div class="explorer-moves" id="analysis-moves">
                    <div class="explorer-placeholder">Analysiere...</div>
                </div>
            </div>
            
            <!-- Opening Explorer Section -->
            <div class="explorer-section">
                <div class="explorer-header">
                    <i class="fas fa-database"></i>
                    <span>Lichess Datenbank</span>
                    <span class="explorer-stats" id="explorer-stats"></span>
                </div>
                <div class="explorer-moves" id="explorer-moves">
                    <div class="explorer-placeholder">Züge spielen...</div>
                </div>
            </div>
            
            <div id="pgn-display"></div>
            <div class="action-group">
                <button class="action-btn" onclick="saveLine()" id="save-btn">Speichern</button>
                <button class="action-btn secondary" onclick="cancelAdd()">Abbrechen</button>
            </div>
        </div>

        <div id="selection-mode" class="hidden">
            <h2 class="selection-mode-header">Training Auswahl</h2>
            <input type="search" id="search-input" placeholder="Suche..." oninput="renderSelectionList()">
            <div id="selection-list" class="scrollable-list"></div>
            <div class="action-group">
                <button class="action-btn" onclick="startTrainingFromSelection()">Starten</button>
                <button class="action-btn secondary" onclick="switchUI('view-mode')">Zurück</button>
            </div>
        </div>

        <div id="train-mode" class="hidden">
            <div class="training-dashboard">
                <div class="training-card">
                    <div class="progress-text">
                        <span id="progress-text-left">Fortschritt</span>
                        <span id="progress-text-right">0 / 0</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>

                    <div class="category-label">Aktuelle Variante</div>
                    <div class="active-category-title" id="train-category-display"></div>
                    
                    <div class="status-badge neutral" id="train-status">Du bist dran</div>
                </div>
            </div>
            
            <div class="action-group">
                <button class="action-btn repetition" id="train-toggle-btn" onclick="toggleRepetitionStatus()">
                    <i class="fas fa-bookmark"></i> Wiederholung
                </button>
                <button class="action-btn secondary" onclick="repeatLater()">Später</button>
                <button class="action-btn secondary danger-text" onclick="stopTraining()">Beenden</button>
            </div>
        </div>
    </div>
</div>

<!-- Bot Game Results Overlay -->
<div class="training-results-overlay" id="bot-results-overlay">
    <div class="results-card">
        <div class="results-header">
            <div class="results-icon" id="bot-results-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <h2 class="results-title" id="bot-results-title">Spiel beendet!</h2>
            <p class="results-subtitle" id="bot-results-subtitle">Gut gespielt!</p>
        </div>

        <div class="results-stats">
            <div class="stat-box">
                <div class="stat-label">Deine Genauigkeit</div>
                <div class="stat-value primary-color" id="player-accuracy">0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Bot Genauigkeit</div>
                <div class="stat-value" id="bot-accuracy">0%</div>
            </div>
        </div>

        <div class="results-actions">
            <button class="results-btn primary" onclick="closeBotResults()">
                <i class="fas fa-check"></i> Schließen
            </button>
        </div>
    </div>
</div>

<div class="training-results-overlay" id="training-results-overlay">
    <div class="results-card">
        <div class="results-header">
            <div class="results-icon" id="results-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <h2 class="results-title" id="results-title">Training abgeschlossen!</h2>
            <p class="results-subtitle" id="results-subtitle">Großartige Leistung!</p>
        </div>

        <div class="results-stats">
            <div class="stat-box">
                <div class="stat-value success-color" id="stat-correct">0</div>
                <div class="stat-label">Richtig</div>
            </div>
            <div class="stat-box">
                <div class="stat-value danger-color" id="stat-wrong">0</div>
                <div class="stat-label">Falsch</div>
            </div>
            <div class="stat-box">
                <div class="stat-value primary-color" id="stat-accuracy">0%</div>
                <div class="stat-label">Genauigkeit</div>
            </div>
        </div>

        <div id="wrong-lines-container"></div>

        <div class="results-actions" id="results-actions">
            <button class="results-btn secondary" onclick="closeTrainingResults()">
                <i class="fas fa-times"></i> Schließen
            </button>
        </div>
    </div>
</div>

<!-- Context Menu for Moves -->
<div id="move-context-menu" class="context-menu hidden">
    <div class="context-menu-item" onclick="executeDeleteMove()">
        <i class="fas fa-trash"></i> Zug löschen
    </div>
    <div class="context-menu-item" id="ctx-add-annotation" onclick="executeAddAnnotation()">
        <i class="fas fa-highlighter"></i> Annotation hinzufügen
    </div>
    <div class="context-submenu hidden" id="annotation-submenu">
        <div class="context-menu-item" onclick="pickAnnotation('??')">??</div>
        <div class="context-menu-item" onclick="pickAnnotation('?')">?</div>
        <div class="context-menu-item" onclick="pickAnnotation('?!')">?!</div>
        <div class="context-menu-item" onclick="pickAnnotation('∓')">∓</div>
        <div class="context-menu-item" onclick="pickAnnotation('±')">±</div>
        <div class="context-menu-item" onclick="pickAnnotation('−+')">−+</div>
        <div class="context-menu-item" onclick="pickAnnotation('+−')">+−</div>
        <div class="context-menu-item" onclick="pickAnnotation('=')">=
        </div>
    </div>
</div>

<script src="stockfish-wrapper.js"></script>
<script src="script.js"></script>
<script>
  // Initialize Stockfish when page loads
  window.addEventListener('load', function() {
    initializeStockfish();
  });
</script>
</body>

</html>
